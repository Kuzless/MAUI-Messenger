@page "/chats"
@using MyMessenger.Application.DTO.ChatDTOs
@using MyMessenger.Application.DTO
@using MyMessenger.Maui.Services
@using MyMessenger.Maui.Components.Pages.ParametersPages
@using BlazorPagination
@inject NavigationManager NavigationManager
@inject ChatService chatService

<h1>Chats</h1>
@if (IsLoaded)
{
    <button @onclick="OpenPopup">Parameters</button>

    <SfGrid DataSource="@ChatsList">
        <GridColumns>
            <GridColumn Field="@nameof(ChatDTO.Id)" HeaderText="Id"></GridColumn>
            <GridColumn Field="@nameof(ChatDTO.Name)" HeaderText="Name"></GridColumn>
            <GridColumn>
                <Template>
                    <button @onclick="() => GoToChat(((ChatDTO)context).Id)">Open</button>
                    <button @onclick="() => ShowInviteToChat((ChatDTO)context)">Invite</button>
                    <button @onclick="() => LeaveChat(((ChatDTO)context).Id)">Leave</button>
                    <button @onclick="() => DeleteChat(((ChatDTO)context).Id)">Delete</button>
                </Template>
            </GridColumn>
        </GridColumns>
    </SfGrid>


    <button @onclick="ChangeAddChatVisibility">Add</button>

    @if (showAddMenu)
    {
        <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: grey; padding: 20px; border-block-color: black;">
            <label for="chatName">Chat Name:</label>
            <input type="text" id="chatName" @bind="newChatName" required />
            <div style="margin-top: 10px;">
                <button @onclick="AddChat">Save</button>
            </div>
        </div>
    }
    @if (showInviteMenu)
    {
        <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: grey; padding: 20px; border-block-color: black;">
            <label for="userName">Username:</label>
            <input type="text" id="userName" @bind="userNameToInvite" required />
            <div style="margin-top: 10px;">
                <button @onclick="InviteToChat">Invite</button>
                <button @onclick="CloseInviteMenu">Close</button>
            </div>
        </div>
    }
    <BlazorPager CurrentPage="@currentPage"
                 PageCount="@numberOfPages"
                 OnPageChanged="(async x => { currentPage = x; ChangePage(); })"
                 ShowFirstLast="false"
                 ShowPageNumbers="true"
                 VisiblePages=pageSize />

    if (isWindowVisible)
    {
        <GenericParameters Columns="@Columns" CurrentPage="@CurrentPage" OnSave="@SaveChanges" OnClose="@ClosePopup"></GenericParameters>
    }
}
else
{
    <br>
    <h3>Loading...</h3>
}

@code {
    private IEnumerable<ChatDTO> ChatsList;
    private AllDataRetrievalParametersDTO CurrentPage;
    private List<string> Columns = new List<string> { "Id", "Name" };
    private ChatDTO currentChat = new ChatDTO();

    private bool isWindowVisible = false;
    private bool showAddMenu = false;
    private bool showInviteMenu = false;

    private int numberOfPages;
    private int currentPage;
    private int pageSize;
    string newChatName = "";
    string userNameToInvite = "";

    private bool IsLoaded { get; set; } = false;

    protected override void OnInitialized()
    {
        numberOfPages = 1;
        currentPage = 1;
        pageSize = 10;
        CurrentPage = new AllDataRetrievalParametersDTO() { PageNumber = currentPage, PageSize = pageSize, Sort = new Dictionary<string, bool>() { { "Name", false } }, Subs = ""};
        GetAllChats();
        base.OnInitialized();
        IsLoaded = true;
    }

    private void ChangePage()
    {
        CurrentPage.PageNumber = currentPage;
        GetAllChats();
    }

    private async void GetAllChats()
    {
        DataForGridDTO<ChatDTO> newdata = await chatService.GetAll(CurrentPage, "Chat");
        ChatsList = newdata.Data;
        numberOfPages = newdata.NumberOfPages;
        StateHasChanged();
    }

    private async void AddChat()
    {
        if (!string.IsNullOrEmpty(newChatName))
        {
            await chatService.AddChat(new ChatDTO() { Name = newChatName });
            showAddMenu = false;
            GetAllChats();
        }
    }

    private async void DeleteChat(int id)
    {
        await chatService.DeleteChat(id);
        GetAllChats();
    }
    private async void InviteToChat()
    {
        if (!string.IsNullOrEmpty(userNameToInvite))
        {
            await chatService.InviteToChat(currentChat, userNameToInvite);
            GetAllChats();
        }
        currentChat = new ChatDTO();
        userNameToInvite = "";
    }
    private async void LeaveChat(int chatId)
    {
        await chatService.LeaveChat(chatId);
        GetAllChats();
    }

    private void GoToChat(int id) {
        NavigationManager.NavigateTo($"/chatmessages/{id}");
    }

    private void ShowInviteToChat(ChatDTO chat)
    {
        currentChat = chat;
        showInviteMenu = true;

    }
    private void CloseInviteMenu()
    {
        currentChat = new ChatDTO();
        showInviteMenu = false;
    }
    private void ChangeParametersVisibility()
    {
        isWindowVisible = !isWindowVisible;
    }

    private void ChangeAddChatVisibility()
    {
        showAddMenu = !showAddMenu;
    }

    // Parameters
    void SaveChanges()
    {
        GetAllChats();
    }
    void OpenPopup()
    {
        isWindowVisible = true;
    }
    void ClosePopup()
    {
        isWindowVisible = false;
    }
}
